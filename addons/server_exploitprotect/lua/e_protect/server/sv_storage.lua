local query, db
local escape_str = function(str) return SQLStr(str, true) end

local create_queries = {
    [1] = [[CREATE TABLE IF NOT EXISTS eprotect_ips(
        id INTEGER PRIMARY KEY %s,
        sid64 CHAR(17),
        ip CHAR(15),
        country CHAR(3),
        logged_time INTEGER DEFAULT 0
    )]]
}

local function makeTables()
    for i = 1, #create_queries do
        query(string.format(create_queries[i], eProtect.config["storage_type"] == "sql_local" and "AUTOINCREMENT" or "AUTO_INCREMENT"))
    end
end

if eProtect.config["storage_type"] == "mysql" then
    require("mysqloo")

    query = function() end

    local dbinfo = eProtect.config["mysql_info"]

    db = mysqloo.connect(dbinfo.host, dbinfo.username, dbinfo.password, dbinfo.database, dbinfo.port)

    function db:onConnected()
        print(eProtect.config["prefix"]..slib.getLang("eprotect", eProtect.config["language"], "mysql_successfull"))

        query = function(str, func)
            local q = db:query(str)
            q.onSuccess = function(_, data)
                if func then
                    func(data)
                end
            end

            q.onError = function(_, err) end

            q:start()
        end

        escape_str = function(str) return db:escape(str) end

        makeTables()

        hook.Run("eP:SQLConnected")
    end

    function db:onConnectionFailed(err)
        print(eProtect.config["prefix"]..slib.getLang("eprotect", eProtect.config["language"], "mysql_failed"))
        print( "Error:", err )
    end

    db:connect()
else
    local oldFunc = sql.Query
    query = function(str, func)
        local result = oldFunc(str)

        if func then
            func(result)
        end
    end

    makeTables()
end

local function handleCallbacksCorrelation(parent_tbl, correlated, callback)
    for k,v in ipairs(parent_tbl) do
        if !v then return end
    end
    
    if !callback then return end
    callback(correlated or {})
end

eProtect.correlateIP = function(target, callback)
    if !IsValid(target) then return end

    local sid64 = target:SteamID64()
    local tbl = {}
    query("SELECT * FROM eprotect_ips WHERE sid64 = '"..sid64.."'", function(result)
        if result and result[1] then
            local parent_tbl = {}
            for k, v in ipairs(result) do
                parent_tbl[k] = false
            end

            for key, plydata in ipairs(result) do
                query("SELECT * FROM eprotect_ips WHERE ip = '"..(plydata.ip).."'", function(result)
                    if result and result[1] then
                        for k,v in ipairs(result) do
                            if v.sid64 == sid64 then continue end
                            table.insert(tbl, {sid64 = v.sid64, ip = v.ip})
                        end
                    end

                    parent_tbl[key] = true

                    handleCallbacksCorrelation(parent_tbl, tbl, callback)
                end)
            end
        end
    end)
end

eProtect.showIPs = function(target, ply)
    local sid64 = target:SteamID64()

    query("SELECT * FROM eprotect_ips WHERE sid64 = '"..sid64.."'", function(result)
        if !IsValid(target) or !IsValid(ply) or !result or !result[1] then return end

        result = util.TableToJSON(result)
        result = util.Base64Encode(result)

        net.Start("eP:Handeler")
        net.WriteUInt(4,3)
        net.WriteUInt(target:EntIndex(), 14)
        net.WriteString(result)
        net.WriteBit(0)
        net.Send(ply)
    end)
end

eProtect.registerIP = function(sid64, ip, country, time)
    query("SELECT * FROM eprotect_ips WHERE ip = '"..ip.."' AND sid64 = '"..sid64.."'", function(result)
        if result and result[1] then return end
        query(string.format("INSERT INTO eprotect_ips(ip, sid64, country, logged_time) VALUES('%s', %s, '%s', %s)", escape_str(ip), sid64, escape_str(country), time or os.time()))
    end)
end

if eProtect.config["storage_type"] == "sql_local" then
    hook.Run("eP:SQLConnected")
end